{"version":3,"file":"migrations.mjs","sources":["../../../src/migrations.ts"],"sourcesContent":["import {MigrationOperation} from '@shopify/shopify-app-session-storage';\n\nimport {SqliteConnection} from './sqlite-connection';\n\nexport const migrationList = [\n  new MigrationOperation(\n    'migrateScopeFieldToVarchar1024',\n    migrateScopeFieldToVarchar1024,\n  ),\n];\n\n// need to migrate exisiting scope from varchar 255 to varchar 1024\nasync function migrateScopeFieldToVarchar1024(\n  connection: SqliteConnection,\n): Promise<void> {\n  const tempTableName = `${connection.sessionStorageIdentifier}_for_migrateScopeFieldToVarchar1024`;\n\n  await connection.executeRawQuery('BEGIN');\n\n  //  1. rename exisiting table\n  const rename = `\n    ALTER TABLE ${connection.sessionStorageIdentifier} RENAME TO ${tempTableName};\n  `;\n  await connection.query(rename);\n\n  // 2. Create new table with 1024 chars\n  const newTable = `\n        CREATE TABLE ${connection.sessionStorageIdentifier} (\n          id varchar(255) NOT NULL PRIMARY KEY,\n          shop varchar(255) NOT NULL,\n          state varchar(255) NOT NULL,\n          isOnline integer NOT NULL,\n          expires integer,\n          scope varchar(1024),\n          accessToken varchar(255),\n          onlineAccessInfo varchar(255)\n        );\n      `;\n  await connection.query(newTable);\n\n  // 3. copy all content from old table into new table\n  const insert = `\n    INSERT INTO ${connection.sessionStorageIdentifier} (id,shop,state,isOnline,expires,scope,accessToken,onlineAccessInfo)\n      SELECT id,shop,state,isOnline,expires,scope,accessToken,onlineAccessInfo\n      FROM ${tempTableName};\n  `;\n  await connection.query(insert);\n\n  // 4. Delete old renamed table\n  const drop = `DROP TABLE ${tempTableName};`;\n  await connection.query(drop);\n\n  await connection.executeRawQuery('COMMIT');\n}\n"],"names":[],"mappings":";;AAIO,MAAM,aAAa,GAAG;AAC3B,IAAA,IAAI,kBAAkB,CACpB,gCAAgC,EAChC,8BAA8B,CAC/B;;AAGH;AACA,eAAe,8BAA8B,CAC3C,UAA4B,EAAA;AAE5B,IAAA,MAAM,aAAa,GAAG,CAAA,EAAG,UAAU,CAAC,wBAAwB,qCAAqC;AAEjG,IAAA,MAAM,UAAU,CAAC,eAAe,CAAC,OAAO,CAAC;;AAGzC,IAAA,MAAM,MAAM,GAAG;kBACC,UAAU,CAAC,wBAAwB,CAAA,WAAA,EAAc,aAAa,CAAA;GAC7E;AACD,IAAA,MAAM,UAAU,CAAC,KAAK,CAAC,MAAM,CAAC;;AAG9B,IAAA,MAAM,QAAQ,GAAG;AACI,qBAAA,EAAA,UAAU,CAAC,wBAAwB,CAAA;;;;;;;;;;OAUnD;AACL,IAAA,MAAM,UAAU,CAAC,KAAK,CAAC,QAAQ,CAAC;;AAGhC,IAAA,MAAM,MAAM,GAAG;AACC,gBAAA,EAAA,UAAU,CAAC,wBAAwB,CAAA;;aAExC,aAAa,CAAA;GACvB;AACD,IAAA,MAAM,UAAU,CAAC,KAAK,CAAC,MAAM,CAAC;;AAG9B,IAAA,MAAM,IAAI,GAAG,CAAA,WAAA,EAAc,aAAa,GAAG;AAC3C,IAAA,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC;AAE5B,IAAA,MAAM,UAAU,CAAC,eAAe,CAAC,QAAQ,CAAC;AAC5C;;;;"}